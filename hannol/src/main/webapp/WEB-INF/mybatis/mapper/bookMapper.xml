<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="book">
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*),0)
		FROM GUIDE G
		LEFT OUTER JOIN GUIDEBOOK GB ON G.SCHCODE = GB.SCHCODE
		WHERE GB.USERSCODE = #{usersCode}
	</select>
	
	<select id="listMybook" parameterType="map" resultType="com.sp.mypage.Mybook">
		select * from (
   		select rownum rnum, tb.* from (
				SELECT G.SCHCODE, TIMEZONE, TO_CHAR(WORKDATE,'YYYY-MM-DD') WORKDATE, ROLE, MEMO, G.USERSCODE,
		        	BOOKCODE, GB.NAME, TEL,  TO_CHAR(BOOKDATE,'YYYY-MM-DD') BOOKDATE
				FROM GUIDE G
		        LEFT OUTER JOIN GUIDEBOOK GB ON G.SCHCODE = GB.SCHCODE
				WHERE G.SCHCODE !=0
					AND GB.USERSCODE = #{usersCode}
				ORDER BY BOOKDATE DESC
		<![CDATA[
				) tb where rownum <= #{end}
			)where rnum >= #{start}	
		]]>
	</select>
	
	<delete id="deleteGuideBook" parameterType="Integer">
		DELETE FROM GUIDEBOOK WHERE BOOKCODE = #{bookCode}
	</delete>
	
	<select id="dataCountMagic" parameterType="map" resultType="Integer">
		SELECT COUNT(*) FROM (
		    SELECT m.facilitycode, name, mpTime, COUNT(ticketCode) cnt, TO_CHAR(mpDate, 'YYYY-MM-DD') mpDate
	        FROM magicpass m
	        JOIN facility f ON m.facilitycode=f.facilitycode
	        WHERE usersCode=#{usersCode}
	        group by m.FACILITYCODE, name, mpTime, TO_CHAR(mpDate, 'YYYY-MM-DD')
	        ORDER BY mpDate DESC, mpTime DESC, facilityCode ASC
		)
	</select>
	
	<select id="listMymagic" parameterType="map" resultType="com.sp.magicpass.MagicPass">
		SELECT * FROM(
		    SELECT ROWNUM rnum, tb.* FROM (
		        SELECT m.facilitycode, name, mpTime, COUNT(ticketCode) cnt, TO_CHAR(mpDate, 'YYYY-MM-DD') mpDate
		        FROM magicpass m
		        JOIN facility f ON m.facilitycode=f.facilitycode
		        WHERE usersCode=#{usersCode}
		        group by m.FACILITYCODE, name, mpTime, TO_CHAR(mpDate, 'YYYY-MM-DD')
		        ORDER BY mpDate DESC, mpTime DESC, facilityCode ASC
		    )tb WHERE ROWNUM &lt;=#{end}
		)WHERE rnum &gt;=#{start}
	</select>
	
	<delete id="deleteMagic" parameterType="map">
		DELETE FROM magicpass
		WHERE TO_CHAR(mpDate, 'YYYY-MM-DD')=#{mpDate} 
		AND usersCode = #{usersCode} 
		AND facilitycode=#{facilityCode} 
		AND mpTime=${mpTime}	
	</delete>
</mapper>